# Bilibili 直播 DANMU_MSG 原始 JSON 数据解析文档

本文档基于 `backend/debug_tools/raw.json` 捕获的原始数据，结合 `blivedm` 源码与 B 站协议逆向分析整理。

## JSON 顶层结构

```json
{
  "cmd": "DANMU_MSG",  // 指令类型：普通弹幕消息
  "dm_v2": "",         // 弹幕 v2 协议数据（通常为空字符串，保留字段）
  "info": [...]        // 核心数据数组，包含所有弹幕详情
}
```

## `info` 数组详解

`info` 是一个包含多个元素的数组，各索引位置含义如下：

### info[0]: 弹幕属性元数据 (Metadata)

包含弹幕的展示属性、时间戳、ID等信息。

| 索引 | 值示例 | 含义 | 备注 |
| :--- | :--- | :--- | :--- |
| `0` | `0` | 弹幕模式 | `0`: 滚动, `1`: 顶部, `4`: 底部, `5`: 高级 |
| `1` | `1` | 字体大小 | `1`: 18px (小), `2`: 25px (标准), `3`: 36px (大) |
| `2` | `25` | 字体大小(像素) | 实际显示的像素值 |
| `3` | `16777215` | 弹幕颜色 | 十进制 RGB 值，`16777215` 为白色 (0xFFFFFF) |
| `4` | `1769483310494` | 发送时间戳 | 毫秒级 Unix 时间戳 |
| `5` | `429699554` | 随机数 / 弹幕ID | 用于去重或标识 |
| `6` | `0` | ？？？ | 未知保留字段，通常为 0 |
| `7` | `"acb93b26"` | 用户 Hash | 发送者用户名的 Hash 值 (非 UID)，匿名显示用 |
| `8` | `0` | ？？？ | 未知保留字段 |
| `9` | `0` | ？？？ | 弹幕类型 (如 0: 普通, 1: 包含表情) |
| `10` | `0` | ？？？ | 未知保留字段 |
| `11` | `""` | 气泡背景图 | 只有 VIP/活动弹幕才有，通常为空 |
| `12` | `0` | ？？？ | 未知保留字段 |
| `13` | `"{}"` | 额外配置 | 只有特殊弹幕才有内容 |
| `14` | `"{}"` | 额外配置 | 只有特殊弹幕才有内容 |
| `15` | `{...}` | 详细元数据对象 | 包含 `extra` 字段，不仅包含弹幕颜色、模式，还包含富文本信息 |

**info[0][15] 详细元数据对象 (`extra` JSON 字符串解析):**

*   `"send_from_me": false` - 是否是自己发送的
*   `"mode": 0` - 弹幕模式
*   `"color": 16777215` - 颜色
*   `"content": "测试"` - 弹幕内容
*   `"user_hash": "2897820454"` - 用户哈希
*   `"id_str": "498bfb14be082d2b11213e4ba169782c4554"` - 弹幕唯一字符串 ID
*   `"reply_mid": 0` - 回复的弹幕 ID (如果是回复消息)
*   `"reply_uname": ""` - 回复的用户名 (如果是回复消息)

---

### info[1]: 弹幕内容 (Content)

```json
"测试"
```
*   即用户发送的实际文本内容。

---

### info[2]: 发送者用户信息 (User Info)

| 索引 | 值示例 | 含义 | 备注 |
| :--- | :--- | :--- | :--- |
| `0` | `0` | 用户 UID | 发送者的数字 UID (匿名模式下可能为 0 或隐藏) |
| `1` | `"X***"` | 用户昵称 | 发送者显示的名称 |
| `2` | `0` | 是否房管 | `0`: 否, `1`: 是 |
| `3` | `0` | 是否 VIP | `0`: 否, `1`: 月费老爷 |
| `4` | `0` | 是否年费 VIP | `0`: 否, `1`: 年费老爷 |
| `5` | `10000` | 用户排名 | 也就是舰长榜排名，10000 表示未上榜 |
| `6` | `1` | ？？？ | 可能与实名认证或活跃度有关 |
| `7` | `""` | 用户名颜色 | 十六进制颜色代码，为空则使用默认 |

---

### info[3]: 粉丝勋章信息 (Medal Info)

如果用户佩戴了粉丝牌，此数组非空；否则为空数组 `[]`。

*注：本示例中为空 `[]`，以下为标准结构补充说明：*

| 索引 | 含义 |
| :--- | :--- |
| `0` | 勋章等级 (1-40) |
| `1` | 勋章名称 (如 "米虫") |
| `2` | 主播昵称 |
| `3` | 主播房间号 |
| `4` | 勋章颜色 |
| `5` | 特殊标识 |

---

### info[4]: 用户等级/排名信息 (User Rank)

| 索引 | 值示例 | 含义 | 备注 |
| :--- | :--- | :--- | :--- |
| `0` | `22` | 用户等级 | UL (User Level) 等级 |
| `1` | `0` | ？？？ | 排名变化？ |
| `2` | `5805790` | ？？？ | 排名颜色？ |
| `3` | `">50000"` | 排名文本 | 如 ">50000", "榜1", "榜2" |
| `4` | `0` | ？？？ | 未知 |

---

### info[5]: 队标/头衔 (Title)

| 索引 | 值示例 | 含义 |
| :--- | :--- | :--- |
| `0` | `""` | 头衔名称 (如 "老司机") |
| `1` | `""` | 头衔标识 |

---

### info[6]: ？？？

`0` - 未知保留字段

### info[7]: 舰长/大航海类型 (Guard Type)

`0` - 身份标识。
*   `0`: 普通用户
*   `1`: 总督
*   `2`: 提督
*   `3`: 舰长

### info[8]: ？？？

`null` - 未知保留字段

### info[9]: 弹幕统计 (Stats)

```json
{
  "ct": "D594F9E2", // 校验 Token
  "ts": 1769483310  // 时间戳 (秒)
}
```

### info[10] - info[14]: 其他保留字段

*   `info[10]`: `0`
*   `info[11]`: `0`
*   `info[12]`: `null`
*   `info[13]`: `null`
*   `info[14]`: `0`

### info[15]: ？？？

`1040` - 可能与客户端版本或协议版本有关。

### info[16]: ？？？

`[35]` - 数组，含义未知，可能与用户扩展属性有关。

### info[17]: ？？？

`null`

---

## 关键字段提取总结

如果您需要解析此 JSON，主要关注以下路径：

1.  **弹幕内容**: `info[1]`
2.  **发送者昵称**: `info[2][1]`
3.  **发送者 UID**: `info[2][0]`
4.  **是否房管**: `info[2][2] == 1`
5.  **舰长身份**: `info[7]` (0=普通, 1=总督, 2=提督, 3=舰长)
6.  **粉丝牌等级**: `info[3][0]` (如果 `info[3]` 不为空)
7.  **粉丝牌名称**: `info[3][1]` (如果 `info[3]` 不为空)
8.  **回复对象**: 解析 `info[0][15]["extra"]` JSON 字符串中的 `reply_uname` 字段。
